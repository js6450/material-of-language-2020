<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>#coronavirus poems</title>
    <script src="https://code.jquery.com/jquery-3.5.0.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
</head>
<style>
    body{
        margin: 0;
        overflow: hidden;
        font-family: 'Noto Sans', sans-serif;
    }

    #more{
        position: fixed;
        top: 17px;
        right: 17px;
        z-index: 999;
        padding: 8px 17px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        color: white;
        border: solid white;
        transition: background 0.5s;
    }

    #more:hover{
        cursor: pointer;
        background: rgba(0, 0, 0, 1);
        transition: background 0.5s;
    }

    #close{
        position: fixed;
        top: 17px;
        right: 17px;
        z-index: 999;
        padding: 8px 17px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        color: white;
        border: solid white;
        transition: background 1s;
    }

    #close:hover{
        cursor: pointer;
        background: rgba(0, 0, 0, 1);
        transition: background 1s;
    }

    #intro{
        display: none;
        width: 25%;
        position: fixed;
        background: rgba(255, 255, 255, 0.7);
        right: 0;
        height: 100vh;
        padding: 2.5%;
    }

    #title{
        text-align: center;
    }
</style>
<body>
<div id="more" onclick="toggleintro()">i</div>
<div id="intro">
    <h1 id="title">#coronavirus:<br> a visual poetry</h1>
    <p>This project uses <a target="_blank" href="https://www.tweepy.org/">Tweepy</a> to stream recent tweets filtered by #coronavirus and uses <a target="_blank" href="https://textblob.readthedocs.io/en/dev/index.html">TextBlob</a> for sentiment analysis to generate the visualizations of the tweets. 3 tweets are displayed at a given time, and new tweets are continuously retrieved for new visualizations.</p>
    <p>The size of the text and the amount of sideways movement depend on how subjective the tweet is. Tweets with positive sentiments travel towards the top, and those with negative sentiments move towards the bottom. If sentiment of a tweet is very negative (score of less than -0.5) then there is added noise to the generated visualization, making the tweets less readable.</p>
    <p>The server is written in python with <a target="_blank" href="https://flask.palletsprojects.com/en/1.1.x/">Flask</a> and uses <a target="_blank" href="https://socket.io/">socket.io</a> to pass on data to the web client. Text visualizations are generated by extracting points of font data of the text of the tweets using <a target="_blank" href="https://github.com/aparrish/bezmerizing">Bezmerizing</a>.</p>
    <p>Created by <a target="_blank" href="http://jiwonshin.com/">Jiwon Shin</a>.</p>
</div>
</body>
<script>

    let tweets = [];
    let texts = [];
    let socket;
    const Y_AXIS = 1;
    const X_AXIS = 2;

    $(document).ready(function(){
        // socket = io.connect("http://" + document.domain + ":" + location.port);
        socket = io.connect("https://tweet-py.herokuapp.com/");

        socket.on("connected", function(msg){
            console.log(msg.data);

            socket.emit('request-data', {'data': null})
        });

        socket.on("disconnected", function(msg){
            console.log(msg.data);
        });

        socket.on("tweet-data", function(msg){
           // if(msg.data.length === 0){
           //     socket.emit('request-data', {'data': null});
           //     console.log("data null, ask again");
           // }else{
            tweets = msg.data;
            processTweets(tweets);
           //}
        });

    });

    function toggleintro(){
        let infodiv = document.getElementById('intro');

        if(infodiv.style.display === 'none'){
            infodiv.style.display = 'block';
        }else{
            infodiv.style.display = 'none';
        }
    }

    function setup(){
        createCanvas(windowWidth, windowHeight);

        frameRate(20);
    }

    function draw(){
        background(0);

        setGradient(0, 0, width, height / 6, color(255), color(0), Y_AXIS);
        setGradient(0, height / 6 * 5, width, height / 4, color(0), color(255), Y_AXIS);

        if(texts.length > 0){
            let donecount = 0;

            for(let i = 0; i < texts.length; i++){
                texts[i].update();
                texts[i].display();

                if(texts[i].done){
                    donecount++;
                }
            }

            if(donecount === texts.length){
                //socket.emit('request-data', {'data': null})
                donecount = 0;
                texts = []
            }
        }

        // fill(255, 0, 0);
        // text(frameRate(), 50, 50);

    }

    function processTweets(data){
        if(texts.length === 0){
            for(let i = 0; i < data.length; i++){
                texts.push(new TweetText(data[i], i))
            }
        }

    }

    function setGradient(x, y, w, h, c1, c2, axis) {
        noFill();

        if (axis === Y_AXIS) {
            // Top to bottom gradient
            for (let i = y; i <= y + h; i++) {
                let inter = map(i, y, y + h, 0, 1);
                let c = lerpColor(c1, c2, inter);
                stroke(c);
                line(x, i, x + w, i);
            }
            } else if (axis === X_AXIS) {
        // Left to right gradient
                for (let i = x; i <= x + w; i++) {
                let inter = map(i, x, x + w, 0, 1);
                let c = lerpColor(c1, c2, inter);
                stroke(c);
                line(i, y, i, y + h);
            }
        }
    }

    function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
    }

    class TweetText{
        constructor(tweet, id){
            this.rawtext = tweet[0];
            this.points = tweet[1];
            this.polarity = tweet[2][0];
            this.subjectivity = tweet[2][1];

            this.width = random(300, 450);

            this.x = 0;
            this.startx = random(width / tweets.length * id, width / tweets.length * (id + 1) - this.width);
            this.y = height / 2;
            this.xspeed = this.subjectivity * 25;

            this.randspeed = 0;
            if(this.polarity > 0){
                this.randspeed = random(0, 2);
            }else{
                this.randspeed = random(-2, 0);
            }

            this.yspeed = -(this.polarity * 5 + this.randspeed);
            this.sinspeed = map(this.polarity, -1, 1, 0.2, 0.05);

            this.xoffset = 0;
            this.yoffset = 0;

            for(let i = 0; i < this.points.length; i++){
                if(this.points[i][0] - this.xoffset > this.width){
                    this.yoffset += 20;
                    this.xoffset += this.width;
                }

                this.points[i][0] = this.points[i][0] - this.xoffset;
                this.points[i][1] = this.points[i][1] + this.yoffset;
            }

            this.done = false;

            this.noise = 0;

            if(this.polarity < 0){
                this.noise = map(this.polarity, -1, 0, 5, 1);
            }

            this.timestart = millis();
        }

        update(){
            this.x = this.startx + this.xspeed * sin(frameCount * this.sinspeed);
            //this.x = this.startx;

            this.y += this.yspeed;
            //
            if(this.x > width - this.width){
                this.xspeed *= -1;
                this.x = width - this.width;
            }

            if(this.x < 0){
                this.xspeed *= -1;
                this.x = 0;
            }

            if(this.y > height){
                this.done = true;
            }

            if(this.y < 0){
                this.done = true;
            }

            if(millis() - this.timestart > 30000){
                this.done = true;
            }
        }

        display(){
            if(!this.done){
                push();
                translate(this.x, this.y);
                // fill(255, 0, 0);
                // ellipse(0, 0, 10, 10);
                stroke(255, map(int(abs(this.y - (height / 2))), 0, height / 2, 255, 0));

                for(let i = 0; i < this.points.length - 1; i++){
                    line(this.points[i][0] + random(-this.noise, this.noise), this.points[i][1] + random(-this.noise, this.noise), this.points[i + 1][0] + random(-this.noise, this.noise), this.points[i + 1][1] + random(-this.noise, this.noise));
                }
                pop();
            }
        }
    }
</script>
</html>